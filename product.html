<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Ù…Ù†ØªØ¬ | Ù…ØªØ¬Ø± Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</title>
    <meta name="description" id="pageDescription" content="Ø§ÙƒØªØ´Ù Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ Ø§Ù„ÙØ§Ø®Ø±Ø© ÙÙŠ Ù…ØªØ¬Ø± Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª">
    <link rel="canonical" id="pageCanonical" href="">
    
    <!-- Open Graph -->
    <meta property="og:type" content="product">
    <meta property="og:title" id="ogTitle" content="">
    <meta property="og:description" id="ogDescription" content="">
    <meta property="og:image" id="ogImage" content="">
    <meta property="og:url" id="ogUrl" content="">
    <meta property="og:site_name" content="Ù…ØªØ¬Ø± Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitterTitle" content="">
    <meta name="twitter:description" id="twitterDescription" content="">
    <meta name="twitter:image" id="twitterImage" content="">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    /* styles unchanged for brevity */
    </style>
</head>

<body>
    <!-- markup unchanged for brevity -->

    <!-- Products Data MUST load before logic -->
    <script src="products-data.js"></script>

    <script>
        let currentProduct = null;
        let retries = 0;
        const MAX_RETRIES = 10; // 1s total with 100ms steps

        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            const val = urlParams.get(name);
            // Handle Arabic and encoded slugs safely
            return val ? decodeURIComponent(val) : null;
        }

        function normalizeSlug(s){
            // remove surrounding spaces and normalize Arabic forms
            return (s || '')
                .trim()
                .replace(/\u200f|\u200e/g,'') // LRM/RLM
                .replace(/\s+/g,'-');
        }

        function generateStars(rating){
            const full = Math.floor(rating);
            const half = rating % 1 >= 0.5;
            let html='';
            for(let i=0;i<full;i++) html+='<i class="fas fa-star"></i>';
            if(half) html+='<i class="fas fa-star-half-alt"></i>';
            for(let i=0;i<5-full-(half?1:0);i++) html+='<i class="far fa-star"></i>';
            return html;
        }

        function updatePageSEO(product){
            const baseUrl = window.location.origin;
            const currentUrl = `${baseUrl}/product.html?slug=${encodeURIComponent(product.slug)}`;
            document.getElementById('pageTitle').textContent = `${product.title} | Ù…ØªØ¬Ø± Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª`;
            document.getElementById('pageDescription').content = product.description;
            document.getElementById('pageCanonical').href = currentUrl;
            document.getElementById('ogTitle').content = product.title;
            document.getElementById('ogDescription').content = product.description;
            document.getElementById('ogImage').content = product.image;
            document.getElementById('ogUrl').content = currentUrl;
            document.getElementById('twitterTitle').content = product.title;
            document.getElementById('twitterDescription').content = product.description;
            document.getElementById('twitterImage').content = product.image;
        }

        function addStructuredData(product){
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.textContent = JSON.stringify({
                "@context":"https://schema.org/",
                "@type":"Product",
                name: product.title,
                image: product.image,
                description: product.description,
                brand:{"@type":"Brand",name:product.brand},
                category: product.category,
                offers:{"@type":"Offer",url:`${window.location.origin}/product.html?slug=${encodeURIComponent(product.slug)}`,priceCurrency:"AED",price: product.salePrice||product.price,availability:"https://schema.org/InStock",itemCondition:"https://schema.org/NewCondition"},
                aggregateRating:{"@type":"AggregateRating",ratingValue:product.rating,reviewCount:product.reviewsCount,bestRating:"5",worstRating:"1"}
            });
            document.head.appendChild(script);
        }

        function displayProduct(product){
            currentProduct = product;
            updatePageSEO(product);
            addStructuredData(product);
            document.getElementById('categoryBreadcrumb').textContent = product.category;
            document.getElementById('productBreadcrumb').textContent = product.title;
            const img = document.getElementById('productImage');
            img.src = product.image;
            img.alt = product.title;
            document.getElementById('productCategory').textContent = product.category;
            document.getElementById('productBrand').textContent = product.brand;
            document.getElementById('productTitle').textContent = product.title;
            document.getElementById('productDescription').textContent = product.description;
            document.getElementById('productStars').innerHTML = generateStars(product.rating);
            document.getElementById('ratingNumber').textContent = (product.rating||0).toFixed(1);
            document.getElementById('reviewsCount').textContent = `(${product.reviewsCount||0} ØªÙ‚ÙŠÙŠÙ…)`;
            document.getElementById('currentPrice').textContent = `${product.salePrice||product.price} Ø¯Ø±Ù‡Ù…`;
            const originalPriceEl = document.getElementById('originalPrice');
            const savingsAmountEl = document.getElementById('savingsAmount');
            if(product.price > (product.salePrice||product.price)){
                originalPriceEl.textContent = `${product.price} Ø¯Ø±Ù‡Ù…`;
                originalPriceEl.style.display='inline';
                const savings = product.price - (product.salePrice||product.price);
                savingsAmountEl.textContent = `ÙˆÙØ± ${savings} Ø¯Ø±Ù‡Ù…`;
                savingsAmountEl.style.display='inline';
            } else {
                originalPriceEl.style.display='none';
                savingsAmountEl.style.display='none';
            }
            const badges = document.getElementById('productBadges');
            badges.innerHTML='';
            if(product.price > (product.salePrice||product.price)){
                const discount = Math.round((product.price - (product.salePrice||product.price)) / product.price * 100);
                badges.innerHTML += `<span class="product-badge">-${discount}%</span>`;
            }
            if(product.featured){
                badges.innerHTML += `<span class="product-badge featured">Ù…Ù…ÙŠØ²</span>`;
            }
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('productContent').classList.remove('hidden');
        }

        function showError(){
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('productContent').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        function tryLoadProduct(){
            const rawSlug = getURLParameter('slug');
            if(!rawSlug){ showError(); return; }
            const slug = normalizeSlug(rawSlug);
            if(typeof window.getProductBySlug === 'function'){
                // try exact, then encoded/decoded variations
                let product = window.getProductBySlug(slug) || window.getProductBySlug(encodeURIComponent(slug)) || window.getProductBySlug(decodeURIComponent(slug));
                // also try loose match for Arabic title-derived slugs
                if(!product && Array.isArray(window.productsData)){
                    product = window.productsData.find(p => normalizeSlug(p.slug) === slug);
                }
                if(product){
                    displayProduct(product); return;
                }
                if(retries < MAX_RETRIES){
                    retries++; setTimeout(tryLoadProduct, 150); return;
                }
                showError();
            } else {
                if(retries < MAX_RETRIES){ retries++; setTimeout(tryLoadProduct, 150); } else { showError(); }
            }
        }

        // Start
        document.addEventListener('DOMContentLoaded', function(){
            // ensure data script loaded
            if(typeof window.productsData === 'undefined'){
                // small delay to allow products-data.js to parse on slow devices
                setTimeout(tryLoadProduct, 200);
            } else {
                tryLoadProduct();
            }
        });

        function changeQuantity(delta){
            const input = document.getElementById('productQuantity');
            let v = parseInt(input.value)||1; v += delta; if(v<1) v=1; if(v>10) v=10; input.value=v;
        }
        function orderWhatsApp(){ if(!currentProduct) return; const q=document.getElementById('productQuantity').value; const msg=`Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬:\n\nðŸ“¦ ${currentProduct.title}\nðŸ’° Ø§Ù„Ø³Ø¹Ø±: ${currentProduct.salePrice||currentProduct.price} Ø¯Ø±Ù‡Ù…\nðŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©: ${q}\nðŸ·ï¸ Ø§Ù„ÙØ¦Ø©: ${currentProduct.category}\nðŸª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${currentProduct.brand}\n\nØ±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬: ${window.location.href}\n\nØ´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ… â¤ï¸ ðŸ‡¦ðŸ‡ª`; window.open(`https://wa.me/201110760081?text=${encodeURIComponent(msg)}`,'_blank'); }
        function emailProduct(){ if(!currentProduct) return; const subject=`Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† ${currentProduct.title}`; const body=`Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ\n\nØ£Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬:\n\nðŸ“¦ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: ${currentProduct.title}\nðŸ’° Ø§Ù„Ø³Ø¹Ø±: ${currentProduct.salePrice||currentProduct.price} Ø¯Ø±Ù‡Ù…\nðŸ·ï¸ Ø§Ù„ÙØ¦Ø©: ${currentProduct.category}\nðŸª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${currentProduct.brand}\n\nØ±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬: ${window.location.href}\n\nØ´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ….`; window.open(`mailto:sherow1982@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,'_blank'); }
        function shareProduct(){ if(!currentProduct) return; const data={ title:`${currentProduct.title} - Ù…ØªØ¬Ø± Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª`, text:`Ø§ÙƒØªØ´Ù ${currentProduct.title} Ø¨Ø³Ø¹Ø± ${currentProduct.salePrice||currentProduct.price} Ø¯Ø±Ù‡Ù…`, url: window.location.href }; if(navigator.share){ navigator.share(data); } else { const t=`${data.text} - ${data.url}`; if(navigator.clipboard){ navigator.clipboard.writeText(t).then(()=>alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬!')); } else { const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬!'); } } }

        if (typeof gtag !== 'undefined') { gtag('event','page_view',{page_title:'Product Page',page_location:window.location.href}); }
    </script>
</body>
</html>